version: '3.8'

services:
  # Backend Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: sharebuddy-backend
    restart: unless-stopped
    ports:
      - "5001:5001"
    environment:
      - NODE_ENV=production
      - PORT=5001
      # Database configuration (external PostgreSQL)
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      # JWT configuration
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=7d
      # Security
      - BCRYPT_SALT_ROUNDS=12
      - SESSION_SECRET=${SESSION_SECRET}
      # File upload
      - UPLOAD_PATH=uploads
      - MAX_FILE_SIZE=10485760
      - MAX_AVATAR_SIZE=5242880
      # CORS
      - FRONTEND_URL=https://sharebuddy.dingleberries.space
      # Rate limiting
      - RATE_LIMIT_WINDOW=900000
      - RATE_LIMIT_MAX=100
      # Module 1: Email Configuration
      - EMAIL_USER=${EMAIL_USER}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD}
      - EMAIL_FROM=${EMAIL_FROM:-ShareBuddy <noreply@sharebuddy.com>}
      - EMAIL_VERIFICATION_EXPIRES=${EMAIL_VERIFICATION_EXPIRES:-24h}
      - PASSWORD_RESET_EXPIRES=${PASSWORD_RESET_EXPIRES:-1h}
      # Module 2: OAuth Configuration
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_CALLBACK_URL=${GOOGLE_CALLBACK_URL:-http://localhost:5001/api/auth/google/callback}
      - FACEBOOK_APP_ID=${FACEBOOK_APP_ID}
      - FACEBOOK_APP_SECRET=${FACEBOOK_APP_SECRET}
      - FACEBOOK_CALLBACK_URL=${FACEBOOK_CALLBACK_URL:-http://localhost:5001/api/auth/facebook/callback}
      # Module 3: Stripe Configuration
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
      # Module 4: Moderation System
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MODERATION_SERVICE_URL=http://moderation-service:5002
      - MODERATION_WEBHOOK_SECRET=${MODERATION_WEBHOOK_SECRET:-default-webhook-secret-change-in-production}
    volumes:
      - backend-uploads:/app/uploads
      - upload-temp:/app/uploads/temp
    networks:
      - sharebuddy-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Redis Service (Message Queue for Moderation)
  redis:
    image: redis:7-alpine
    container_name: sharebuddy-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - sharebuddy-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Moderation Service (AI-powered content analysis)
  moderation-service:
    build:
      context: ./moderation-service
      dockerfile: Dockerfile
    container_name: sharebuddy-moderation
    restart: unless-stopped
    ports:
      - "5002:5002"
    environment:
      - NODE_ENV=production
      - PORT=5002
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - BACKEND_WEBHOOK_URL=http://backend:5001/api/webhooks/moderation
      - BACKEND_WEBHOOK_SECRET=${MODERATION_WEBHOOK_SECRET:-default-webhook-secret-change-in-production}
    volumes:
      - backend-uploads:/app/uploads:ro
      - upload-temp:/app/uploads/temp:ro
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - sharebuddy-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - REACT_APP_API_URL=https://sharebuddy.dingleberries.space
        - REACT_APP_APP_NAME=ShareBuddy
        - REACT_APP_VERSION=1.0.0
    container_name: sharebuddy-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - sharebuddy-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Volumes
volumes:
  backend-uploads:
    driver: local
  upload-temp:
    driver: local
  redis-data:
    driver: local

# Networks
networks:
  sharebuddy-network:
    driver: bridge
